name: Build and Publish Release Packages

permissions:
    contents: write

on:
    release:
        types: [published, prereleased]

env:
    CARGO_TERM_COLOR: always
    APP_NAME: vk

jobs:
    build:
        name: Build binaries
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      target: x86_64-apple-darwin
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc

        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Add target
              run: rustup target add ${{ matrix.target }}

            # Build binaries
            - name: Build binaries
              run: |
                  cargo build --release --bin vk --features full --target ${{ matrix.target }}
                  cargo build --release --bin vk-ci --no-default-features --features minimal --target ${{ matrix.target }}

            # ---------- Unix Packaging ----------
            - name: Package (Unix)
              if: runner.os != 'Windows'
              run: |
                  mkdir -p out
                  tar -czf "out/${APP_NAME}-${{ matrix.target }}.tar.gz" -C "target/${{ matrix.target }}/release" vk
                  tar -czf "out/${APP_NAME}-ci-${{ matrix.target }}.tar.gz" -C "target/${{ matrix.target }}/release" vk-ci
                  cd out && sha256sum *.tar.gz > "checksums-${{ matrix.target }}.txt"

            # ---------- Windows Packaging ----------
            - name: Package (Windows)
              if: runner.os == 'Windows'
              shell: powershell
              run: |
                  New-Item -ItemType Directory -Force -Path out
                  Compress-Archive -Path "target\${{ matrix.target }}\release\vk.exe" -DestinationPath "out\${env:APP_NAME}-${{ matrix.target }}.zip"
                  Compress-Archive -Path "target\${{ matrix.target }}\release\vk-ci.exe" -DestinationPath "out\${env:APP_NAME}-ci-${{ matrix.target }}.zip"
                  Get-FileHash out/*.zip -Algorithm SHA256 | ForEach-Object {
                    "$($_.Hash) $(Split-Path $_.Path -Leaf)" | Out-File "out\checksums-${{ matrix.target }}.txt" -Append -Encoding ascii
                  }

            - name: Upload intermediate artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: artifacts-${{ matrix.target }}
                  path: out/*

    release:
        name: Upload to GitHub Release
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all_artifacts
                  merge-multiple: true

            - name: Publish Assets
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event.release.tag_name }}
                  files: |
                      all_artifacts/*.tar.gz
                      all_artifacts/*.zip
                      all_artifacts/checksums-*.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
