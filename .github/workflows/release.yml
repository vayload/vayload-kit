name: Build and publish release packages

permissions:
    contents: write

on:
    release:
        types: [published]

env:
    CARGO_TERM_COLOR: always
    APP_NAME: vk
    VERSION: ${{ github.event.release.tag_name }}

jobs:
    build:
        name: Build binaries
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      target: x86_64-apple-darwin
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc

        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Add target
              run: rustup target add ${{ matrix.target }}

            # Build vk
            - name: Build vk (full)
              run: cargo build --release --bin vk --features full --target ${{ matrix.target }}

            # Build vk-ci
            - name: Build vk-ci (minimal)
              run: cargo build --release --bin vk-ci --no-default-features --features minimal --target ${{ matrix.target }}

            # ---------- Linux / macOS ----------
            - name: Package vk (Unix)
              if: runner.os != 'Windows'
              run: |
                  mkdir -p dist/vk
                  tar -czf dist/vk/${APP_NAME}-${{ matrix.target }}.tar.gz \
                    -C target/${{ matrix.target }}/release vk
                  cd dist/vk
                  sha256sum * > checksums-${{ matrix.target }}.txt

            - name: Package vk-ci (Unix)
              if: runner.os != 'Windows'
              run: |
                  mkdir -p dist/vk-ci
                  tar -czf dist/vk-ci/${APP_NAME}-ci-${{ matrix.target }}.tar.gz \
                    -C target/${{ matrix.target }}/release vk-ci
                  cd dist/vk-ci
                  sha256sum * > checksums-${{ matrix.target }}.txt

            # ---------- Windows ----------
            - name: Package vk (Windows)
              if: runner.os == 'Windows'
              shell: powershell
              run: |
                  New-Item -ItemType Directory -Force -Path dist\vk
                  Copy-Item target\${{ matrix.target }}\release\vk.exe dist\vk\${APP_NAME}-${{ matrix.target }}.exe
                  Compress-Archive -Path dist\vk\* -DestinationPath dist\vk\${APP_NAME}-${{ matrix.target }}.zip
                  Get-FileHash dist\vk\${APP_NAME}-${{ matrix.target }}.zip -Algorithm SHA256 | ForEach-Object {
                    "$($_.Hash) $($_.Name)" | Out-File dist\vk/checksums-${{ matrix.target }}.txt -Append -Encoding ascii
                  }

            - name: Package vk-ci (Windows)
              if: runner.os == 'Windows'
              shell: powershell
              run: |
                  New-Item -ItemType Directory -Force -Path dist\vk-ci
                  Copy-Item target\${{ matrix.target }}\release\vk-ci.exe dist\vk-ci\${APP_NAME}-ci-${{ matrix.target }}.exe
                  Compress-Archive -Path dist\vk-ci\* -DestinationPath dist\vk-ci\${APP_NAME}-ci-${{ matrix.target }}.zip
                  Get-FileHash dist\vk-ci\${APP_NAME}-ci-${{ matrix.target }}.zip -Algorithm SHA256 | ForEach-Object {
                    "$($_.Hash) $($_.Name)" | Out-File dist\vk-ci/checksums-${{ matrix.target }}.txt -Append -Encoding ascii
                  }

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.target }}
                  path: dist/*

    release:
        name: Create GitHub Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Upload assets to Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/**/*
