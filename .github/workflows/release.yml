name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always
    APP_NAME: vk
    VERSION: ${{ github.ref_name }}

jobs:
    test:
        name: Tests & Lints
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy, rustfmt

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Format check
              run: cargo fmt --all -- --check

            - name: Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Tests
              run: cargo test --all-features

    build:
        name: Build binaries
        needs: test
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      target: x86_64-apple-darwin
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc

        steps:
            - uses: actions/checkout@v4

            - uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Add target
              run: rustup target add ${{ matrix.target }}

            - name: Build vk (full)
              run: cargo build --release --bin vk --features full --target ${{ matrix.target }}

            - name: Build vk-ci (minimal)
              run: cargo build --release --bin vk-ci --no-default-features --features minimal --target ${{ matrix.target }}

            # ---------- Linux / macOS ----------
            - name: Package (Unix)
              if: runner.os != 'Windows'
              run: |
                  mkdir dist

                  cp target/${{ matrix.target }}/release/vk \
                     dist/${APP_NAME}-${VERSION}-${{ matrix.target }}

                  cp target/${{ matrix.target }}/release/vk-ci \
                     dist/${APP_NAME}-ci-${VERSION}-${{ matrix.target }}

                  strip dist/* || true

                  cd dist
                  sha256sum * > checksums-${VERSION}-${{ matrix.target }}.txt

            # ---------- Windows ----------
            - name: Package (Windows)
              if: runner.os == 'Windows'
              shell: powershell
              run: |
                  New-Item -ItemType Directory -Force -Path dist

                  Copy-Item target\${{ matrix.target }}\release\vk.exe `
                    dist\${{ env.APP_NAME }}-${{ env.VERSION }}-${{ matrix.target }}.exe

                  Copy-Item target\${{ matrix.target }}\release\vk-ci.exe `
                    dist\${{ env.APP_NAME }}-ci-${{ env.VERSION }}-${{ matrix.target }}.exe

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.target }}
                  path: dist/*

    release:
        name: Create GitHub Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/**/*
